Object.defineProperty(exports,"__esModule",{value:true});exports.default=undefined;var _createClass=function(){function defineProperties(target,props){for(var i=0;i<props.length;i++){var descriptor=props[i];descriptor.enumerable=descriptor.enumerable||false;descriptor.configurable=true;if("value"in descriptor)descriptor.writable=true;Object.defineProperty(target,descriptor.key,descriptor);}}return function(Constructor,protoProps,staticProps){if(protoProps)defineProperties(Constructor.prototype,protoProps);if(staticProps)defineProperties(Constructor,staticProps);return Constructor;};}();var _PureFunctions=require("./PureFunctions");function _defineProperty(obj,key,value){if(key in obj){Object.defineProperty(obj,key,{value:value,enumerable:true,configurable:true,writable:true});}else{obj[key]=value;}return obj;}function _toArray(arr){return Array.isArray(arr)?arr:Array.from(arr);}function _classCallCheck(instance,Constructor){if(!(instance instanceof Constructor)){throw new TypeError("Cannot call a class as a function");}}var Pipeline=function(){_createClass(Pipeline,[{key:"_then",value:function _then(fn){this.__then=fn;}}]);function Pipeline(name){var _this=this;_classCallCheck(this,Pipeline);this._pipeline=true;this.setLevel=function(parentLevel,skipLevel){var _level=skipLevel?0:(parentLevel||0)+1;if(_level>50){throw new Error("Maximum 50 retries exceeded in pipeline");}_this._level=_level;};this.runTask=function(task,data,parent,connector,output,rest){var taskResult=void 0;if(task._pipeline){task.setLevel(_this._level,_this._skipLevel);taskResult=task.init(connector,data,parent);}else if(typeof task!=="function"){throw new Error("task must be a function but found >> "+JSON.stringify(task));}else{taskResult=task(data,parent);}if(taskResult&&taskResult._pipeline){taskResult.setLevel(_this._level,_this._skipLevel);taskResult=taskResult.init(connector,data,parent);}else if(taskResult&&!taskResult.then&&typeof taskResult==="function"){taskResult=taskResult(connector);}if(taskResult&&taskResult.then){return taskResult.then(function(result){return _this.next(result,parent,output,data,rest,connector);});}else{return _this.next(taskResult,parent,output,data,rest,connector);}};this.iterateMap=function(field,_ref,parent,accum,task,output,data,rest,connector){var _ref2=_toArray(_ref),first=_ref2[0],restArray=_ref2.slice(1);if(first===undefined){return _this.next(_defineProperty({},field,accum),parent,output,data,rest,connector);}var p=_this.runTask(task,first,data,connector,output,rest);if(p&&p.then){return p.then(function(v){accum.push(p);return _this.iterateMap(field,restArray,parent,accum,task,output,data,rest,connector);});}else{accum.push(p);return _this.iterateMap(field,restArray,parent,accum,task,output,data,rest,connector);}};this.runTasks=function(data,parent,_ref3,connector){var _ref4=_toArray(_ref3),first=_ref4[0],rest=_ref4.slice(1);if(first===undefined){return data;}var map=first.map,task=first.task,output=first.output;if(map){if(parent){throw new Error("map inside map is not supported in pipeline >> Previous map field ["+map+"]");}var arrayValue=data[map];if(!arrayValue||arrayValue.length===0){return _this.next(null,parent,output,data,rest,connector);}else{return _this.iterateMap(map,arrayValue,parent,[],task,output,data,rest,connector);}}else{return _this.runTask(task,data,parent,connector,output,rest);}};this.init=function(connector,data,parent){if(_this._data!==undefined){data=_this._data;}var p=_this.runTasks(data,parent,_this.tasks,connector);if(p&&p.then){return p.then(function(res){if(_this.__then){_this.__then();}return res;});}else{if(_this.__then){_this.__then();}return p;}};this.output=function(output){_this._output=output;return _this;};this.skipLevel=function(_skipLevel){_this._skipLevel=_skipLevel;return _this;};this._name=name;this.tasks=[];}_createClass(Pipeline,[{key:"param",value:function param(data){this._data=data;return this;}},{key:"add",value:function add(task,output){this.tasks.push({task:task,output:output});return this;}},{key:"pipelineData",value:function pipelineData(){this._pipelineData=true;return this;}},{key:"map",value:function map(key,task){this.tasks.push({map:key,task:task});return this;}},{key:"next",value:function next(result,parent,output,data,rest,connector){var _this2=this;if(output){result=output(data,result);}if(result&&result._pipeline){result.setLevel(this._level,this._skipLevel);result=result.init(connector,data,parent);if(result&&result.then){return result.then(function(result){return _this2.next(result,parent,null,data,rest,connector);});}}if((!rest||!rest.length)&&this._pipelineData){return result;}if(result){if(!(0,_PureFunctions.isJSONObject)(result)){throw new Error("Task result must be a json object but found >>>> "+JSON.stringify(result));}for(var k in result){data[k]=result[k];}}if(rest&&rest.length>0){return this.runTasks(data,parent,rest,connector);}else{return data;}}}],[{key:"of",value:function of(name){return new Pipeline(name);}}]);return Pipeline;}();exports.default=Pipeline;