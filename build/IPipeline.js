Object.defineProperty(exports,"__esModule",{value:true});exports.default=undefined;var _extends=Object.assign||function(target){for(var i=1;i<arguments.length;i++){var source=arguments[i];for(var key in source){if(Object.prototype.hasOwnProperty.call(source,key)){target[key]=source[key];}}}return target;};var _createClass=function(){function defineProperties(target,props){for(var i=0;i<props.length;i++){var descriptor=props[i];descriptor.enumerable=descriptor.enumerable||false;descriptor.configurable=true;if("value"in descriptor)descriptor.writable=true;Object.defineProperty(target,descriptor.key,descriptor);}}return function(Constructor,protoProps,staticProps){if(protoProps)defineProperties(Constructor.prototype,protoProps);if(staticProps)defineProperties(Constructor,staticProps);return Constructor;};}();var _Pipeline=require("./Pipeline");var _Pipeline2=_interopRequireDefault(_Pipeline);function _interopRequireDefault(obj){return obj&&obj.__esModule?obj:{default:obj};}function _toArray(arr){return Array.isArray(arr)?arr:Array.from(arr);}function _classCallCheck(instance,Constructor){if(!(instance instanceof Constructor)){throw new TypeError("Cannot call a class as a function");}}var IPipeline=function(){function IPipeline(name){var _this=this;_classCallCheck(this,IPipeline);this._pipeline=true;this.setLevel=function(parentLevel){var _level=(parentLevel||0)+1;if(_level>50){throw new Error("Maximum 50 retries exceeded in pipeline");}_this._level=_level;};this.runTask=function(data,parent,taskToRun,index,connector){var task=taskToRun.task,output=taskToRun.output;var result=null;return new Promise(function(resolve,reject){try{if(_this._dbConnect){var _dbConnect=_this._dbConnect,dbConnect=_dbConnect.dbConnect,args=_dbConnect.args;var cloneDBConnect=dbConnect(connector);args=_extends({},args,{_dbConnect:cloneDBConnect});task=task({args:args});}var response=_Pipeline2.default.of(_this._name+" - "+index).add(task).init(connector,{});if(response instanceof Promise){return response.then(resolve).catch(reject);}else{resolve(response);}}catch(e){reject(e);}}).then(function(_result){result={result:_result};data.successCount=data.successCount||0;data.successCount=data.successCount+1;return connector.commit();}).catch(function(err){console.log("Error in IPipeline > Id: ",_this._name,", Error: ",err.stack);data.errorCount=data.errorCount||0;data.errorCount=data.errorCount+1;data.errors=data.errors||[];var error={source:_this._name,message:err.message,stack:err.stack,index:index};data.errors.push(error);result={error:err};return connector.rollback();}).then(function(){if(output){var outputConnector=connector&&connector.clone&&connector.clone();if(_this._dbConnect){var _dbConnect2=_this._dbConnect,dbConnect=_dbConnect2.dbConnect,args=_dbConnect2.args;var cloneDBConnect=dbConnect(outputConnector);args=_extends({},args,{_dbConnect:cloneDBConnect});output=output({args:args});}var outputPipeline=_Pipeline2.default.of(_this._name+" - "+index+" - output").pipelineData().add(output).param(result).init(outputConnector);if(outputPipeline&&outputPipeline.then){return outputPipeline.then(function(){return outputConnector.txEnabled&&outputConnector.commit();}).catch(function(){return outputConnector.txEnabled&&outputConnector.rollback();});}else{return outputPipeline;}}}).then(function(response){if(response){if(response||result.error){var log={index:index};if(result.error){log.error=result.error.stack;}if(response){log.response=JSON.stringify(response);}data.response=data.response||[];data.response.push(log);}}});};this.runTasks=function(data,parent,_ref,connector){var _ref2=_toArray(_ref),first=_ref2[0],rest=_ref2.slice(1);if(!first){data.endTime=new Date();data.totalTime=data.endTime-data.startTime;data.source=_this._name;var pipeline=_Pipeline2.default.of(_this._name+" - "+index+" - onEnd").param(data);var onEndConnector=connector;if(connector.txEnabled){onEndConnector=connector.clone();}if(_this._onEnd){if(_this._dbConnect){var _dbConnect3=_this._dbConnect,dbConnect=_dbConnect3.dbConnect,args=_dbConnect3.args;var cloneDBConnect=dbConnect(onEndConnector);args=_extends({},args,{_dbConnect:cloneDBConnect});_this._onEnd=_this._onEnd({args:args});}pipeline.add(_this._onEnd);}pipeline.add(function(){return function(_connector){return _connector.insert("ipipeline_logs",data,void 0,void 0,{skipTx:true});};});if(_this.__then){pipeline._then(_this.__then);}return pipeline.init(onEndConnector).then(function(){return onEndConnector.commit();}).catch(function(){return onEndConnector.rollback();});}var index=_this.tasks.length-rest.length-1;var newConnector=connector;if(connector.txEnabled){newConnector=connector.clone();}return _this.runTask(data,parent,first,index,newConnector).then(function(){return _this.runTasks(data,parent,rest,connector);});};this.init=function(connector,data,parent){if(_this._data!==undefined){data=_this._data;}data.startTime=new Date();var p=_this.runTasks(data,parent,_this.tasks,connector);if(_this._async){return null;}else{return p;}};this.dbConnect=function(dbConnect,args){_this._dbConnect={dbConnect:dbConnect,args:args};return _this;};this._name=name;this.tasks=[];}_createClass(IPipeline,[{key:"_then",value:function _then(fn){this.__then=fn;}},{key:"onEnd",value:function onEnd(_onEnd){this._onEnd=_onEnd;return this;}},{key:"async",value:function async(_async){this._async=_async;return this;}},{key:"param",value:function param(data){this._data=data;return this;}},{key:"add",value:function add(task,output){this.tasks.push({task:task,output:output});return this;}}],[{key:"of",value:function of(name){return new IPipeline(name);}}]);return IPipeline;}();exports.default=IPipeline;