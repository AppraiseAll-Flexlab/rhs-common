var Moment=require("moment");var Constants={STARTS_ON:"startsOn",REPEATS:"repeats",Repeats:{NEVER:"Never",MINUTELY:"Minutely",HOURLY:"Hourly",DAILY:"Daily",WEEKLY:"Weekly",MONTHLY:"Monthly",QUARTERLY:"Quarterly",YEARLY:"Yearly"},PLAN:"plan",Plan:{TODAY:"Today",WEEK:"Week",MONTH:"Month",LATER:"Later"},Quarterly:{REPEAT_QUARTER_ON:"repeatQuarterOn"},REPEAT_EVERY:"repeatEvery",REPEAT_ON:"repeatOn",REPEAT_BY:"repeatBy",NEXT_DUE_ON:"nextDueOn",NEXT_ACTIVE_ON:"nextActiveOn",ENDS_ON:"endsOn",ACTIVE_BEFORE:"activeBefore"};var Weeks={Sun:0,Mon:1,Tue:2,Wed:3,Thu:4,Fri:5,Sat:6};var Days={"1":1,"2":2,"3":3,"4":4,"5":5,"6":6,"7":7,"8":8,"9":9,"10":10,"11":11,"12":12,"13":13,"14":14,"15":15,"16":16,"17":17,"18":18,"19":19,"20":20,"21":21,"22":22,"23":23,"24":24,"25":25,"26":26,"27":27,"28":28,"29":29,"30":30,"31":31,lastDay:31};var Months={Jan:0,Feb:1,Mar:2,Apr:3,May:4,Jun:5,Jul:6,Aug:7,Sep:8,Oct:9,Nov:10,Dec:11};var Quarters={1:[0,1,2],2:[3,4,5],3:[6,7,8],4:[9,10,11]};var getNextDueDate=function getNextDueDate(when,now){return populateNextDueDate(when,now);};function populateNextDueDate(when,now){var repeats=when[Constants.REPEATS];if(!repeats||repeats.trim().length===0||repeats===Constants.Repeats.NEVER){return;}var repeatBy=when[Constants.REPEAT_BY];var currentDate=Moment(now).toDate();if(now&&typeof now=="string"){now=Moment(now).toDate();}var activeBefore=when[Constants.ACTIVE_BEFORE];if(activeBefore&&typeof activeBefore==="string"){activeBefore=parseInt(activeBefore);}var startsOn=when[Constants.STARTS_ON]||void 0;var whenRepeatOn=when[Constants.REPEAT_ON];var repeatQuarterOn=when[Constants.Quarterly.REPEAT_QUARTER_ON];if(repeats===Constants.Repeats.QUARTERLY&&(!repeatQuarterOn||!repeatBy)){throw new Error("repeatQuarterOn/repeatby is mandatory in schedule");}if(startsOn&&startsOn>currentDate&&(!whenRepeatOn||whenRepeatOn.length==0)){var nextDueOn=Moment(startsOn).toDate();var nextActiveOn=getActiveBeforeDate(nextDueOn,activeBefore);return{nextDueOn:nextDueOn,nextActiveOn:nextActiveOn};}var repeatEvery=when[Constants.REPEAT_EVERY]?parseInt(when[Constants.REPEAT_EVERY]):1;var repeatOn=sortRepeatedOn(whenRepeatOn,repeats,startsOn||now,repeatBy);var repeatedOnLength=repeatOn.length;var nextDueOnDate=when[Constants.NEXT_DUE_ON];var nextActiveOnDate=when[Constants.NEXT_ACTIVE_ON];var prevActiveOnDate=nextActiveOnDate?Moment(nextActiveOnDate).toDate():void 0;var timeInMinutes=getTimeInMinutes(nextActiveOnDate||nextDueOnDate||startsOn||now);var currentTimeInMinutes=getTimeInMinutes(currentDate);while(!nextActiveOnDate||nextDueOnDate<currentDate||!isValidDate(prevActiveOnDate,nextActiveOnDate)){if(!nextDueOnDate){nextDueOnDate=Moment(startsOn&&(repeatEvery>1||startsOn>currentDate)?startsOn:now).startOf("day").add("minutes",timeInMinutes).toDate();}if((repeats===Constants.Repeats.MINUTELY||repeats===Constants.Repeats.HOURLY)&&currentTimeInMinutes&&timeInMinutes>currentTimeInMinutes){nextDueOnDate=Moment(nextDueOnDate).subtract("days",1).toDate();currentTimeInMinutes=0;}else if(repeatedOnLength>0){var firstRepeatOnDate=nextDueOnDate;var firstRepeatOnActiveDate=nextActiveOnDate;for(var i=0;i<repeatedOnLength;i++){var repeat=repeatOn[i];var calculatedActiveOnDate=void 0;var calculatedDueOnDate=getCalculatedDueOnDate({repeats:repeats,nextDueOnDate:nextDueOnDate,repeat:repeat,startsOn:startsOn,repeatQuarterOn:repeatQuarterOn,repeatOn:repeatOn,repeatEvery:repeatEvery,repeatBy:repeatBy});calculatedActiveOnDate=getActiveBeforeDate(calculatedDueOnDate,activeBefore);if(calculatedDueOnDate>=currentDate&&isValidDate(prevActiveOnDate,calculatedActiveOnDate)&&(!startsOn||calculatedDueOnDate>=startsOn)){return{nextDueOn:calculatedDueOnDate,nextActiveOn:calculatedActiveOnDate};}if(i==0){firstRepeatOnDate=calculatedDueOnDate;firstRepeatOnActiveDate=calculatedActiveOnDate;}}nextDueOnDate=firstRepeatOnDate;nextActiveOnDate=firstRepeatOnActiveDate;}if(nextDueOnDate<currentDate||!isValidDate(prevActiveOnDate,nextActiveOnDate)){if(repeats===Constants.Repeats.MINUTELY){nextDueOnDate=Moment(nextDueOnDate).add("minutes",repeatEvery).toDate();}else if(repeats===Constants.Repeats.HOURLY){nextDueOnDate=Moment(nextDueOnDate).add("minutes",repeatEvery*60).toDate();}else if(repeats===Constants.Repeats.DAILY){nextDueOnDate=Moment(nextDueOnDate).add("days",repeatEvery).toDate();}else if(repeats===Constants.Repeats.WEEKLY){nextDueOnDate=Moment(nextDueOnDate).add("days",repeatEvery*7).toDate();}else if(repeats===Constants.Repeats.MONTHLY){nextDueOnDate=Moment(nextDueOnDate).add("months",repeatEvery).toDate();}else if(repeats===Constants.Repeats.YEARLY){nextDueOnDate=Moment(nextDueOnDate).add("year",repeatEvery).toDate();}else if(repeats===Constants.Repeats.QUARTERLY){if(repeatBy===Constants.Repeats.WEEKLY){var nextWeeklyDate=Moment(nextDueOnDate).add("days",1*7).toDate();if(Quarters[Moment(nextWeeklyDate).quarter()][repeatQuarterOn-1]!==nextWeeklyDate.getMonth()){nextDueOnDate=getNextQuarterWeekDate({nextDueOnDate:nextDueOnDate,repeatEvery:repeatEvery,repeatOn:repeatOn});}else{nextDueOnDate=nextWeeklyDate;}}else{nextDueOnDate=Moment(nextDueOnDate).add("quarters",repeatEvery).toDate();}}else{throw new Error("Invalid value for repeats ["+repeats+"]");}}if(startsOn&&nextDueOnDate<startsOn){nextDueOnDate=modifyCalculatedDueOnDateWithStartsOn({repeats:repeats,nextDueOnDate:nextDueOnDate});}nextActiveOnDate=getActiveBeforeDate(nextDueOnDate,activeBefore);}return{nextActiveOn:nextActiveOnDate,nextDueOn:nextDueOnDate};}var modifyCalculatedDueOnDateWithStartsOn=function modifyCalculatedDueOnDateWithStartsOn(_ref){var repeats=_ref.repeats,repeatEvery=_ref.repeatEvery,nextDueOnDate=_ref.nextDueOnDate;if(repeats===Constants.Repeats.WEEKLY){nextDueOnDate=Moment(nextDueOnDate).add("days",1*7).toDate();}if(repeats===Constants.Repeats.MONTHLY){var maxDays=getMaximumNoOfDays(nextDueOnDate.getMonth(),nextDueOnDate.getYear());nextDueOnDate=Moment(nextDueOnDate).add("months",1).toDate();}return nextDueOnDate;};function getCalculatedDueOnDate(_ref2){var repeats=_ref2.repeats,nextDueOnDate=_ref2.nextDueOnDate,repeat=_ref2.repeat,startsOn=_ref2.startsOn,repeatQuarterOn=_ref2.repeatQuarterOn,repeatOn=_ref2.repeatOn,repeatBy=_ref2.repeatBy,repeatEvery=_ref2.repeatEvery;var calculatedDueOnDate=void 0;if(repeats===Constants.Repeats.WEEKLY){calculatedDueOnDate=Moment(nextDueOnDate).day(repeat).toDate();}else if(repeats===Constants.Repeats.MONTHLY){var maxDays=getMaximumNoOfDays(nextDueOnDate.getMonth(),nextDueOnDate.getYear());calculatedDueOnDate=Moment(nextDueOnDate).set("date",repeat>maxDays?maxDays:repeat).toDate();}else if(repeats===Constants.Repeats.YEARLY){calculatedDueOnDate=Moment(nextDueOnDate).set("month",repeat).toDate();var maxDays=getMaximumNoOfDays(calculatedDueOnDate.getMonth(),calculatedDueOnDate.getYear());var yearDayOfMonth=startsOn?Moment(startsOn).toDate().getDate():Moment(nextDueOnDate).toDate().getDate();calculatedDueOnDate.setDate(yearDayOfMonth>maxDays?maxDays:yearDayOfMonth);}else if(repeats===Constants.Repeats.QUARTERLY){var quarterMonthDate=getQuarterMonthDate({nextDueOnDate:nextDueOnDate,repeatQuarterOn:repeatQuarterOn});calculatedDueOnDate=getCalculatedDueOnDate({repeats:repeatBy,nextDueOnDate:quarterMonthDate,repeat:repeat});if(repeatBy===Constants.Repeats.WEEKLY&&calculatedDueOnDate.getMonth()-quarterMonthDate.getMonth()>0){calculatedDueOnDate=getNextQuarterWeekDate({nextDueOnDate:quarterMonthDate,repeatEvery:repeatEvery,repeatOn:repeatOn});}}return calculatedDueOnDate;}var getQuarterMonthDate=function getQuarterMonthDate(_ref3){var nextDueOnDate=_ref3.nextDueOnDate,repeatQuarterOn=_ref3.repeatQuarterOn;var presentQuarter=Moment(nextDueOnDate).quarter();var quarterMonth=repeatQuarterOn?parseInt(repeatQuarterOn):1;var presentMonth=nextDueOnDate.getMonth();var index=Quarters[presentQuarter].indexOf(presentMonth);var monthDiff=quarterMonth-(index+1);if(monthDiff!==0){nextDueOnDate=Moment(nextDueOnDate).add("months",monthDiff).set("date",1).toDate();}return nextDueOnDate;};var getNextQuarterWeekDate=function getNextQuarterWeekDate(_ref4){var nextDueOnDate=_ref4.nextDueOnDate,repeatEvery=_ref4.repeatEvery,repeatOn=_ref4.repeatOn;nextDueOnDate=Moment(nextDueOnDate).add("quarters",repeatEvery).set("date",1).toDate();for(var i=0;i<repeatOn.length;i++){var repeatOnDate=Moment(nextDueOnDate).day(repeatOn[i]).toDate();if(repeatOnDate.getMonth()===nextDueOnDate.getMonth()){return repeatOnDate;}}};var isValidDate=function isValidDate(prevActiveOnDate,currentActiveOnDate){if(!prevActiveOnDate||prevActiveOnDate<currentActiveOnDate){return true;}};function getActiveBeforeDate(dueDate,activeBefore){if(activeBefore){return Moment(dueDate).subtract("days",activeBefore).toDate();}else{return dueDate;}}function get(date,minutes,currentDate){if(date>currentDate){return date;}date=Moment(date).add("minutes",minutes).toDate();return get(date,minutes,currentDate);}function getMaximumNoOfDays(month,year){return[31,isLeapYear(year)?29:28,31,30,31,30,31,31,30,31,30,31][month];}function isLeapYear(year){return year%4===0&&year%100!==0||year%400===0;}function sortRepeatedOn(repeatOn,repeat,startsOn,repeatBy){var sortedRepeatOn=[];if(!repeatOn||repeatOn.length==0){startsOn=Moment(startsOn);if(repeat==Constants.Repeats.WEEKLY||repeatBy===Constants.Repeats.WEEKLY){sortedRepeatOn.push(startsOn.day());}else if(repeat==Constants.Repeats.MONTHLY||repeatBy===Constants.Repeats.MONTHLY){sortedRepeatOn.push(startsOn.toDate().getDate());}else if(repeat==Constants.Repeats.YEARLY){sortedRepeatOn.push(startsOn.toDate().getMonth());}}else{if(repeat==Constants.Repeats.WEEKLY||repeatBy===Constants.Repeats.WEEKLY){for(var weekDay in Weeks){if(repeatOn.indexOf(weekDay)!=-1){sortedRepeatOn.push(Weeks[weekDay]);}}}else if(repeat==Constants.Repeats.MONTHLY||repeatBy===Constants.Repeats.MONTHLY){for(var day in Days){if(repeatOn.indexOf(day)!=-1){sortedRepeatOn.push(Days[day]);}}}else if(repeat==Constants.Repeats.YEARLY){for(var month in Months){if(repeatOn.indexOf(month)!=-1){sortedRepeatOn.push(Months[month]);}}}}return sortedRepeatOn;}function getTimeInMinutes(date){return date?date.getHours()*60+date.getMinutes():0;}module.exports={getNextDueDate:getNextDueDate};