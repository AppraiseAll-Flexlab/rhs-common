Object.defineProperty(exports,"__esModule",{value:true});exports.resolveDottedValue=exports.putDottedValue=exports.getMemorySort=exports.getNativeSort=exports.isNativeSort=exports.populateReferredFks=exports.isThenable=exports.asyncIterator=exports.getRelationFilterPipeline=exports.getRelationFilter=exports.getJoinFilter=exports.getJoinFilterOneByOne=exports.isWhenRequired=exports.mergeQueryFields=exports.matchedIndex=exports.validateDataPipeline=exports.resolveOnChange=exports.populateDottedFields=exports.getNestedValidations=exports.getValidations=exports.getNestedComputations=exports.getComputations=exports.getFilterValue=exports.getIdFilter=exports.isReferenceField=exports.getReferenceFields=exports.getSubModelObjects=exports.getSubModels=exports.getSubQueries=exports.getRelations=exports.getSchema=exports.isBoolean=exports.isDate=exports.isNumber=exports.isNull=exports.getFieldType=exports.getNestedFields=exports.getRequiredParamValue=exports.getMergedFilter=exports.getMergedFields=exports.getChangesFromMergedData=exports.separateNestedChanges=exports.getNullOrObject=exports.getArrayFieldsChangesIfOverride=exports.compute=exports.computeInternally=exports.computeRecursively=exports.getQueryInstance=exports.getAffectedComputations=exports.isChangeExist=exports.getDocumentToRunComputation=exports.aggregateDifferences=exports.mergeOldWithChangesForComputation=exports.getArrayChanges=exports.getMatchedIndex=exports.getRecordWithId=exports.isEqual=exports.isIdFilter=exports.matchExists=exports.isNotEqFilter=exports.isExistsFilter=exports.isMatch=exports.isLtOrGt=exports.isElemMatchFilter=exports.isNotInFilter=exports.isInFilter=exports.matchLtOrGt=exports.elemMatch=exports.matchNotIn=exports.matchIn=exports.isLeafMatch=exports.matchOr=exports.matchAnd=exports.resolveValue=exports.resolveValue1=exports.deepEqual=exports.deepClone=exports.isJSONObject=undefined;var _extends=Object.assign||function(target){for(var i=1;i<arguments.length;i++){var source=arguments[i];for(var key in source){if(Object.prototype.hasOwnProperty.call(source,key)){target[key]=source[key];}}}return target;};var _Pipeline=require("./Pipeline");var _Pipeline2=_interopRequireDefault(_Pipeline);var _Query=require("./Query");var _Query2=_interopRequireDefault(_Query);var _lodash=require("lodash");var _Validation=require("./Validation");var _Validation2=_interopRequireDefault(_Validation);var _v=require("uuid/v4");var _v2=_interopRequireDefault(_v);function _interopRequireDefault(obj){return obj&&obj.__esModule?obj:{default:obj};}function _toConsumableArray(arr){if(Array.isArray(arr)){for(var i=0,arr2=Array(arr.length);i<arr.length;i++){arr2[i]=arr[i];}return arr2;}else{return Array.from(arr);}}function _defineProperty(obj,key,value){if(key in obj){Object.defineProperty(obj,key,{value:value,enumerable:true,configurable:true,writable:true});}else{obj[key]=value;}return obj;}function _objectWithoutProperties(obj,keys){var target={};for(var i in obj){if(keys.indexOf(i)>=0)continue;if(!Object.prototype.hasOwnProperty.call(obj,i))continue;target[i]=obj[i];}return target;}var ObjConstructor={}.constructor;var isJSONObject=exports.isJSONObject=function isJSONObject(obj){if(obj===undefined||obj===null||obj===true||obj===false||typeof obj!=="object"||Array.isArray(obj)){return false;}else if(obj.constructor===ObjConstructor||obj.constructor===undefined){return true;}else{return false;}};var deepClone=exports.deepClone=function deepClone(value){var typeOfValue=typeof value;var cloneValue=value;if(!value||typeOfValue==="boolean"||typeOfValue==="string"||typeOfValue==="function"||typeOfValue==="number"){}else if(value instanceof Date){cloneValue=new Date(value);}else if(value instanceof Array){cloneValue=value.map(deepClone);}else if(isJSONObject(value)){cloneValue={};for(var key in value){cloneValue[key]=deepClone(value[key]);}}return cloneValue;};var deepEqual=exports.deepEqual=function deepEqual(first,second){if(!first||!second){return first===second;}if(first===second){return true;}else if(Array.isArray(first)&&Array.isArray(second)){var firstLength=first.length;var secondLength=second.length;if(firstLength!==secondLength){return false;}else{for(var i=0;i<firstLength;i++){if(!deepEqual(first[i],second[i])){return false;}}return true;}}else if(typeof first===typeof second&&typeof first==="number"&&isNaN(first)&&isNaN(second)){return true;}else if(first instanceof Date&&second instanceof Date){if(first.getTime()===second.getTime()){return true;}else{return false;}}else if(isJSONObject(first)&&isJSONObject(second)){var firstKeys=Object.keys(first);var secondKeys=Object.keys(second);if(firstKeys.length!==secondKeys.length){return false;}else{for(var k=0;k<firstKeys.length;k++){var keyName=firstKeys[k];if(!deepEqual(first[keyName],second[keyName])){return false;}}return true;}}else if(first.toString&&second.toString&&first.toString()===second.toString()){return true;}else{return false;}};var resolveValue1=exports.resolveValue1=function resolveValue1(values,key){if(!values||!key){return values;}if(Array.isArray(values)){var result=[];for(var i=0;i<values.length;i++){var row=values[i];var resolvedValue=resolveValue1(row,key);if(resolvedValue!==undefined){if(Array.isArray(resolvedValue)){for(var j=0;j<resolvedValue.length;j++){if(key!=="_id"||result.indexOf(resolvedValue[j])===-1){result.push(resolvedValue[j]);}}}else{if(key!=="_id"||result.indexOf(resolvedValue)===-1){result.push(resolvedValue);}}}}return result;}else{var value=values[key];if(value!==undefined){return value;}var indexOf=key.indexOf(".");if(indexOf===-1){return;}var firstPart=key.substring(0,indexOf);var nextPart=key.substring(indexOf+1);return resolveValue1(values[firstPart],nextPart);}};var resolveValue=exports.resolveValue=function resolveValue(values,key){if(!values||!key){return values;}var result=getValue(values,key);if(result===undefined||Array.isArray(result)&&result.length===0){var indexOf=key.indexOf(".");if(indexOf===-1){return result;}var firstPart=key.substring(0,indexOf);var nextPart=key.substring(indexOf+1);result=getValue(values,firstPart);if(result===undefined||Array.isArray(result)&&result.length===0){return result;}else{return resolveValue(result,nextPart);}}return result;};var getValue=function getValue(values,key){var result=void 0;if(Array.isArray(values)){result=(0,_lodash.flatten)((0,_lodash.map)(values,key));}else{result=(0,_lodash.get)(values,key);}if(Array.isArray(result)){result=(0,_lodash.uniq)(result);}if(Array.isArray(result)){result=(0,_lodash.pullAll)(result,[undefined]);}return result;};var matchAnd=exports.matchAnd=function matchAnd(row,filter){if(!Array.isArray(filter)){throw new Error("And filter must be array, but found >> "+JSON.stringify(filter));}for(var k=0;k<filter.length;k++){if(!isMatch(row,filter[k])){return false;}}return true;};var matchOr=exports.matchOr=function matchOr(row,filter){if(!Array.isArray(filter)){throw new Error("Or filter must be array, but found >> "+JSON.stringify(filter));}for(var k=0;k<filter.length;k++){if(isMatch(row,filter[k])){return true;}}return false;};var isLeafMatch=exports.isLeafMatch=function isLeafMatch(rowValue,filterValue){if(Array.isArray(rowValue)){for(var i=0;i<rowValue.length;i++){if(isLeafMatch(rowValue[i],filterValue)){return true;}}}else if((rowValue===undefined||rowValue===null)&&filterValue===null||rowValue===filterValue||rowValue&&rowValue["equals"]&&rowValue.equals(filterValue)){return true;}else{return false;}};var matchIn=exports.matchIn=function matchIn(value,filterValue){var filter=filterValue["$in"];if(!Array.isArray(filter)){throw new Error("In filter must be array, but found >> "+JSON.stringify(filter));}for(var k=0;k<filter.length;k++){if((value===undefined||value===null)&&filter[k]===null){return true;}else if(isLeafMatch(value,filter[k])){return true;}}return false;};var matchNotIn=exports.matchNotIn=function matchNotIn(value,filterValue){var filter=filterValue["$nin"];if(!Array.isArray(filter)){throw new Error("In filter must be array, but found >> "+JSON.stringify(filter));}for(var k=0;k<filter.length;k++){if(isLeafMatch(value,filter[k])){return false;}}return true;};var elemMatch=exports.elemMatch=function elemMatch(value,filterValue){var filter=filterValue["$elemMatch"];if(!isJSONObject(filter)){throw new Error("ElemMatch filter must be object, but found >> "+JSON.stringify(filter));}if(!Array.isArray(value)){throw new Error("Value must be array, but found >> "+JSON.stringify(value));}for(var k=0;k<value.length;k++){if(isMatch(value[k],filter)){return true;}}return false;};var matchLtOrGt=exports.matchLtOrGt=function matchLtOrGt(value,filterValue){for(var k in filterValue){var kValue=filterValue[k];var matched=false;if(k==="$lt"){matched=value<kValue;}else if(k==="$gt"){matched=value>kValue;}else if(k==="$lte"){matched=value<=kValue;}else if(k==="$gte"){matched=value>=kValue;}else if(k==="$eq"){matched=value===kValue;}else{throw new Error("Only $lt,$gt,$lte,$gte are supported but found ["+k+"], filter is "+JSON.stringify(filterValue)+" ");}if(!matched){return false;}}return true;};var isInFilter=exports.isInFilter=function isInFilter(value){return value&&typeof value==="object"&&value.hasOwnProperty("$in")?true:false;};var isNotInFilter=exports.isNotInFilter=function isNotInFilter(value){return value&&typeof value==="object"&&value.hasOwnProperty("$nin")?true:false;};var isElemMatchFilter=exports.isElemMatchFilter=function isElemMatchFilter(value){return value&&typeof value==="object"&&value.hasOwnProperty("$elemMatch")?true:false;};var isLtOrGt=exports.isLtOrGt=function isLtOrGt(value){return value&&typeof value==="object"&&(value.hasOwnProperty("$lt")||value.hasOwnProperty("$lte")||value.hasOwnProperty("$gt")||value.hasOwnProperty("$gte")||value.hasOwnProperty("$eq"))?true:false;};var isMatch=exports.isMatch=function isMatch(row,filter){for(var k in filter){var filterValue=filter[k];var matched=false;if(k==="$and"){matched=matchAnd(row,filterValue);}else if(k==="$or"){matched=matchOr(row,filterValue);}else{var rowValue=resolveValue(row,k);if(isInFilter(filterValue)){matched=matchIn(rowValue,filterValue);}else if(isNotInFilter(filterValue)){matched=matchNotIn(rowValue,filterValue);}else if(isLtOrGt(filterValue)){matched=matchLtOrGt(rowValue,filterValue);}else if(isExistsFilter(filterValue)){matched=matchExists(filterValue.$exists,rowValue);}else if(isElemMatchFilter(filterValue)){matched=elemMatch(rowValue,filterValue);}else if(isNotEqFilter(filterValue)){matched=!isLeafMatch(rowValue,filterValue.$ne);}else{matched=isLeafMatch(rowValue,filterValue);}}if(!matched){return false;}}return true;};var isExistsFilter=exports.isExistsFilter=function isExistsFilter(value){return value&&typeof value==="object"&&value.hasOwnProperty("$exists");};var isNotEqFilter=exports.isNotEqFilter=function isNotEqFilter(value){return value&&typeof value==="object"&&value.hasOwnProperty("$ne");};var matchExists=exports.matchExists=function matchExists(valueToMatch,value){return valueToMatch===true&&value!==void 0||valueToMatch===false&&value===void 0;};var isIdFilter=exports.isIdFilter=function isIdFilter(filter){return filter&&typeof filter==="object"&&filter.hasOwnProperty("_id")&&Object.keys(filter).length===1&&!isJSONObject(filter["_id"])?true:false;};var isEqual=exports.isEqual=function isEqual(doc,_id){if(!doc||doc._id===undefined||_id===undefined){return;}return _id&&doc._id===_id||_id.equals&&_id.equals(doc._id)||doc._id.equals&&doc._id.equals(_id);};var getRecordWithId=exports.getRecordWithId=function getRecordWithId(data,_id){return data&&data.find(function(doc){return isEqual(doc,_id);});};var getMatchedIndex=exports.getMatchedIndex=function getMatchedIndex(data,_id){if(!data||!data.length){return-1;}for(var i=0;i<data.length;i++){if(isEqual(data[i],_id)){return i;}}};var getArrayChanges=function getArrayChanges(newData,oldData){var isNew=newData&&newData.length;var isOld=oldData&&oldData.length;if(isNew&&isOld){var matchIds={};var changes={};newData.forEach(function(data){var _id=data._id,rest=_objectWithoutProperties(data,["_id"]);var old=getRecordWithId(oldData,_id);if(old){matchIds[old._id]=1;changes.update=changes.update||[];changes.update.push({_id:_id,changes:rest});}else{changes.insert=changes.insert||[];changes.insert.push(data);}});oldData.forEach(function(old){var _id=old._id;if(!matchIds[_id]){changes.remove=changes.remove||[];changes.remove.push({_id:_id});}});return changes;}else if(isNew&&!isOld){return{insert:newData};}else if(isOld&&!isNew){var ids=oldData.map(function(old){return{_id:old._id};});return{remove:ids};}else{return null;}};exports.getArrayChanges=getArrayChanges;var mergeOldWithChangesForComputation=exports.mergeOldWithChangesForComputation=function mergeOldWithChangesForComputation(old,changes,nestedFields,subModelObjects,schema){var _separateNestedChange=separateNestedChanges(changes,nestedFields),selfChanges=_separateNestedChange.selfChanges,nestedChanges=_separateNestedChange.nestedChanges;if(nestedChanges){nestedChanges=getArrayFieldsChangesIfOverride(nestedChanges,old);}var modifiedData={};var fieldChanges={};var fieldIncs={};if(selfChanges){for(var _k in selfChanges){var value=selfChanges[_k];var changeValue=1;if(subModelObjects&&subModelObjects[_k]){var subModelValue=void 0,override=void 0;changeValue={subModelObject:true};if(!value){value=null;override=true;changeValue.override=true;if(old&&old[_k]){var objectFields=old[_k];changeValue.changes=changeValue.changes||{};for(var objectField in objectFields){changeValue["changes"][objectField]=1;}}}else if(value&&isJSONObject(value)){if(value.changes){subModelValue=value.changes;}else{override=true;subModelValue=value;changeValue.override=true;}var _mergeOldWithChangesF=mergeOldWithChangesForComputation(override?null:old&&old[_k],subModelValue),subModelObjectModifiedData=_mergeOldWithChangesF.data,subModelObjectFieldChanges=_mergeOldWithChangesF.changeFields;value=subModelObjectModifiedData;changeValue.changes=subModelObjectFieldChanges;}else{throw new Error("Invalid value for Submodel object field "+_k+" and value is "+JSON.stringify(value));}}else if(isJSONObject(value)&&value.hasOwnProperty("$inc")){var newIncValue=value["$inc"];if(typeof newIncValue!=="number"){throw new Error("While inc operation new value should be a number but not found, field is ["+_k+"] newValue >> ["+JSON.stringify(value)+"]");}var oldValue=old&&old[_k];if(oldValue!==undefined&&oldValue!==null){if(typeof oldValue!=="number"){throw new Error("While inc operation old value should be a number but not found, field is ["+_k+"] newValue >> ["+JSON.stringify(value)+"] >>> old value ["+JSON.stringify(oldValue)+"]");}newIncValue=oldValue+newIncValue;}fieldIncs[_k]={old:oldValue};value=newIncValue;}modifiedData[_k]=value;fieldChanges[_k]=changeValue;}}if(nestedChanges){var _loop=function _loop(_k2){var modifiedArrayValue=[];var _ref=nestedChanges[_k2]||{},insert=_ref.insert,update=_ref.update,remove=_ref.remove;var fieldSubModels=void 0;var fieldType=schema&&getFieldType(schema,_k2);if(fieldType&&fieldType._isSubModel){fieldSubModels=getSubModels(fieldType._schema);}var oldArrayValue=old&&old[_k2];if(oldArrayValue){oldArrayValue.forEach(function(old){var isRemoved=remove&&getRecordWithId(remove,old._id);if(isRemoved){fieldChanges[_k2]=fieldChanges[_k2]||{};fieldChanges[_k2]["remove"]=fieldChanges[_k2]["remove"]||[];fieldChanges[_k2]["remove"].push({_id:old._id,value:old});}else{var updatedRecord=update&&getRecordWithId(update,old._id);if(updatedRecord){var _id=updatedRecord._id,_changes=updatedRecord.changes;var mergedOldValue=_extends({},old,_changes);modifiedArrayValue.push(mergedOldValue);var _updatedFields={};for(var obj in updatedRecord.changes){var objValue=updatedRecord.changes[obj];if(fieldSubModels&&fieldSubModels[obj]&&isJSONObject(objValue)){overrideNestedSubModelValue(obj,objValue,mergedOldValue,old);}_updatedFields[obj]=1;}fieldChanges[_k2]=fieldChanges[_k2]||{};fieldChanges[_k2]["changes"]=fieldChanges[_k2]["changes"]||[];fieldChanges[_k2]["changes"].push({fields:_updatedFields,op:"update",_id:_id});}else{modifiedArrayValue.push(old);}}});}else{if(update){update.forEach(function(value){var _id=value._id,changes=value.changes;modifiedArrayValue.push(_extends({_id:_id},changes));var updatedFields={};for(var obj in changes){updatedFields[obj]=1;var objValue=value.changes[obj];if(fieldSubModels&&fieldSubModels[obj]&&isJSONObject(objValue)){overrideNestedSubModelValue(obj,objValue,changes);}}fieldChanges[_k2]=fieldChanges[_k2]||{};fieldChanges[_k2]["changes"]=fieldChanges[_k2]["changes"]||[];fieldChanges[_k2]["changes"].push({fields:updatedFields,op:"update",_id:_id});});}if(remove){remove.forEach(function(value){var _id=value._id;fieldChanges[_k2]=fieldChanges[_k2]||{};fieldChanges[_k2]["remove"]=fieldChanges[_k2]["remove"]||[];fieldChanges[_k2]["remove"].push({_id:_id});});}}if(insert){insert.forEach(function(value,index){modifiedArrayValue.push(value);if(value._id===undefined){value._id="new_"+index;}var insertedFields={};for(var obj in value){insertedFields[obj]=1;var objValue=value[obj];if(fieldSubModels&&fieldSubModels[obj]&&isJSONObject(objValue)){overrideNestedSubModelValue(obj,objValue,value);}}fieldChanges[_k2]=fieldChanges[_k2]||{};fieldChanges[_k2]["changes"]=fieldChanges[_k2]["changes"]||[];fieldChanges[_k2]["changes"].push({fields:insertedFields,op:"insert",_id:value._id});});}modifiedData[_k2]=modifiedArrayValue;};for(var _k2 in nestedChanges){_loop(_k2);}}if(old){for(var k in old){if(modifiedData[k]===undefined){modifiedData[k]=old[k];}}}return{data:modifiedData,changeFields:fieldChanges,fieldIncs:fieldIncs};};var overrideNestedSubModelValue=function overrideNestedSubModelValue(k,fieldValue,modifiedData,old){var modifiedArrayValue=[];var insert=fieldValue.insert,update=fieldValue.update,remove=fieldValue.remove;var oldArrayValue=old&&old[k];if(oldArrayValue){oldArrayValue.forEach(function(old){var isRemoved=remove&&getRecordWithId(remove,old._id);if(!isRemoved){var updatedRecord=update&&getRecordWithId(update,old._id);if(updatedRecord){var changes=updatedRecord.changes;var mergedOldValue=_extends({},old,changes);modifiedArrayValue.push(mergedOldValue);}else{modifiedArrayValue.push(old);}}});}else{if(update){update.forEach(function(value){var _id=value._id,changes=value.changes;modifiedArrayValue.push(_extends({_id:_id},changes));});}}if(insert){insert.forEach(function(value,index){modifiedArrayValue.push(value);if(value._id===undefined){value._id="new_"+index;}});}modifiedData[k]=modifiedArrayValue;};var getIncOp=function getIncOp(value,multiplier){var newValue={};for(var k in value){newValue[k]={$inc:multiplier*value[k]};}return newValue;};var getDiffOp=function getDiffOp(newValue,oldValue,multiplier){var diffValue={};for(var k in newValue){var nv=newValue[k];var ov=oldValue&&oldValue[k]||0;var diff=nv+multiplier*ov;if(diff>0||diff<0){diffValue[k]=diff;}}for(var _k3 in oldValue){if(!newValue.hasOwnProperty(_k3)){var _ov=oldValue[_k3];if(_ov>0||_ov<0){diffValue[_k3]=_ov;}}}if(Object.keys(diffValue)){return diffValue;}else{return null;}};var reduceSimilarArray=function reduceSimilarArray(array){array=array||{};return array.reduce(function(accum,doc){var filter=doc.filter,value=doc.value;var key=JSON.stringify(filter);var accumDoc=accum[key];if(accumDoc){var prevValue=accumDoc.value;accum[key]={filter:filter,value:getDiffOp(value,prevValue,1)};}else{accum[key]=_extends({},doc);}return accum;},{});};var ensureArray=function ensureArray(data){if(Array.isArray(data)){return data;}else if(data==null||data===undefined){return[];}else{return[data];}};var aggregateDifferences=exports.aggregateDifferences=function aggregateDifferences(newData,oldData){var modifiedNewValue=reduceSimilarArray(ensureArray(newData));var modifiedOldValue=reduceSimilarArray(ensureArray(oldData));var ops=[];for(var k in modifiedOldValue){if(!modifiedNewValue.hasOwnProperty(k)){var oldValue=modifiedOldValue[k];ops.push({filter:oldValue.filter,value:getIncOp(oldValue.value,-1)});}}for(var _k4 in modifiedNewValue){var newValue=modifiedNewValue[_k4];var _oldValue=modifiedOldValue[_k4];var diff=getDiffOp(newValue.value,_oldValue&&_oldValue.value,-1);if(diff){ops.push({filter:newValue.filter,value:getIncOp(diff,1)});}}return ops;};var mergeJsonObject=function mergeJsonObject(actualValue,requireWithDefault,requireValues){var doc={};var toIterate=isJSONObject(requireValues)?requireValues:requireWithDefault;for(var k in toIterate){var newVal=actualValue[k];var defVal=requireWithDefault[k];var v=null;if(isJSONObject(defVal)&&!isJSONObject(newVal)){v=defVal;}else if(isJSONObject(defVal)&&isJSONObject(newVal)){v=mergeJsonObject(newVal,defVal);}else{v=newVal!==undefined?newVal:defVal;}doc[k]=v;}return doc;};var getDocumentToRunComputation=exports.getDocumentToRunComputation=function getDocumentToRunComputation(data,computation,arrayFields){var _require=computation["_require"];var _onChange=computation["_onChange"];var _default=computation["_default"]||{};var valueToUse=getNullOrObject(_require)||getNullOrObject(_onChange);var doc={};var _loop2=function _loop2(){var newVal=data[k];var defVal=_default[k];var v=null;if(arrayFields&&arrayFields[k]&&isJSONObject(defVal)){if(newVal){if(!Array.isArray(newVal)){throw new Error("New value must be of array type if array fields given, array fields are "+JSON.stringify(arrayFields)+" and newValue is "+JSON.stringify(newVal));}v=newVal.map(function(d){return mergeJsonObject(d,defVal);});}else{v=[];}}else if(isJSONObject(defVal)&&!isJSONObject(newVal)){v=defVal;}else if(isJSONObject(defVal)&&isJSONObject(newVal)){v=mergeJsonObject(newVal,defVal,valueToUse[k]);}else{v=newVal!==undefined&&newVal!==null?newVal:defVal;}doc[k]=v;};for(var k in valueToUse){_loop2();}return doc;};var checkChangeInArray=function checkChangeInArray(onChange,arrayChanges){if(!arrayChanges){return false;}if(arrayChanges.remove){return true;}var changes=arrayChanges["changes"];if(changes&&changes.length){for(var i=0;i<changes.length;i++){for(var k in onChange){var fields=changes[i].fields;if(fields&&fields.hasOwnProperty(k)){return true;}}}}else if(arrayChanges.override){return true;}};var isChangeExist=exports.isChangeExist=function isChangeExist(changes,onChange,arrayFields){if(!changes){return;}for(var k in onChange){if(changes.hasOwnProperty(k)){if(arrayFields&&arrayFields[k]){var onChangeValue=onChange[k];if(isJSONObject(onChangeValue)){var changed=checkChangeInArray(onChangeValue,changes[k]);if(changed){return true;}}else{return true;}}else{return true;}}}};var isChangeExistForArray=function isChangeExistForArray(onChange,arrayChanges,docChanges,arrayData,_default){if(!arrayData){return null;}if(onChange&&onChange["_parent"]&&_default){if(isChangeExist(docChanges,_default["_parent"])){return arrayData.map(function(doc){return doc._id;});}}var hasArrayChanges=arrayChanges&&arrayChanges.changes&&arrayChanges.changes.length;if(!hasArrayChanges){return false;}var changes=arrayChanges.changes;var ids=[];changes.forEach(function(change){var fields=change.fields,_id=change._id;if(isChangeExist(fields,onChange)){ids.push(_id);}});if(ids.length){return ids;}};var getAffectedComputations=exports.getAffectedComputations=function getAffectedComputations(data,changes,computations,childComputations,ignoreComputations,arrayFields,op){var computationsToRun={};for(var c in computations){if(ignoreComputations&&ignoreComputations[c]){continue;}var computation=computations[c];var _onChange=computation._onChange,_operation=computation._operation,_field=computation._field;if(_operation&&!_operation[op]){continue;}if(_operation&&!_onChange||isChangeExist(changes,_onChange,arrayFields)){computationsToRun[c]={computation:computation,field:_field||c};}}for(var k in childComputations){var _computations=childComputations[k];for(var _c in _computations){var _computation=_computations[_c];var onChange=_computation["_onChange"];var _default=_computation["_default"];var computationKey="_"+k+"_"+_c+"_";if(ignoreComputations&&ignoreComputations[computationKey]){continue;}if(changes[k]&&changes[k].subModelObject){if(isChangeExist(changes[k].changes,onChange)){computationsToRun[computationKey]={computation:_computation,child:k,field:_c,subModelObject:true};}}else{var ids=isChangeExistForArray(onChange,changes[k],changes,data[k],_default);if(ids){computationsToRun[computationKey]={computation:_computation,ids:ids,child:k,field:_c};}}}}return computationsToRun;};var getNestedDocToRun=function getNestedDocToRun(parentDoc,childDoc,computation){var nestedDoc=getDocumentToRunComputation(childDoc,computation);var _require=getNullOrObject(computation["_require"]);var _onChange=getNullOrObject(computation["_onChange"]);var _default=computation["_default"]||{};var parentFields=_require&&_require._parent?_require._parent:_onChange&&_onChange._parent?_default._parent:null;if(parentFields){var parentValues=mergeJsonObject(parentDoc,parentFields);if(parentValues){nestedDoc=_extends({},nestedDoc,{_parent:parentValues});}}return nestedDoc;};var getQueryInstance=function getQueryInstance(model,query){var _ref2=arguments.length>2&&arguments[2]!==undefined?arguments[2]:{},relationValue=_ref2.relationValue;if(!query||query._query){return query;}if(typeof query==="string"){query={id:query};}var _query2=query,id=_query2.id,limit=_query2.limit,skip=_query2.skip,paramValue=_query2.paramValue,addOnFilter=_query2.addOnFilter,ftsFilter=_query2.ftsFilter,group=_query2.group,skipQueryGroupInAggregate=_query2.skipQueryGroupInAggregate,fieldAggregates=_query2.fieldAggregates,fields=_query2.fields,only=_query2.only,metadata=_query2.metadata,sort=_query2.sort,skipData=_query2.skipData,skipAggregates=_query2.skipAggregates;var modelId=model._id;if(!id){throw new Error("id must be defined in query in model "+modelId);}relationValue=relationValue||query.relationValue;if(typeof model==="function"){model=model();}if(id==="__anonyms__"){var q=_Query2.default.of().id("__anonyms__").fields(query.fields).data(query._data).filter(query.filter);if(only){q=q.only();}if(paramValue!==undefined){q=q.paramValue(paramValue);}return q;}var modelQueries=model["_queries"];var queryInstance=modelQueries&&modelQueries[id];if(!queryInstance){throw new Error("Query not found with id ["+id+"] in model "+modelId);}else if(!queryInstance._query){throw new Error("Query ["+id+"] in model "+modelId+" should be Query Type");}queryInstance=queryInstance.id(id);if(group!==undefined){var unwind=group.unwind,restGroupInfo=_objectWithoutProperties(group,["unwind"]);queryInstance=queryInstance.group(restGroupInfo);if(unwind){queryInstance=queryInstance.unwind(unwind);}queryInstance=queryInstance.skipQueryGroupInAggregate(skipQueryGroupInAggregate);}if(limit!==undefined){queryInstance=queryInstance.limit(limit);}if(skip!==undefined){queryInstance=queryInstance.skip(skip);}if(fieldAggregates!==undefined){queryInstance=queryInstance.fieldAggregates(fieldAggregates);}if(addOnFilter!==undefined){queryInstance=queryInstance.addFilter(addOnFilter);}if(sort!==undefined){queryInstance=queryInstance.sort(sort);}if(ftsFilter!==undefined){queryInstance=queryInstance.addFilter(ftsFilter);}if(relationValue!==undefined){queryInstance=queryInstance.relationValue(relationValue);}if(paramValue!==undefined){queryInstance=queryInstance.paramValue(paramValue);}if(fields!==undefined){queryInstance=queryInstance.fields(fields);}if(only!==undefined){queryInstance=queryInstance.only(only);}if(metadata!==undefined){queryInstance=queryInstance.metadata(metadata);}if(skipData!==undefined){queryInstance=queryInstance.skipData(skipData);}if(skipAggregates!==undefined){queryInstance=queryInstance.skipAggregates(skipAggregates);}return queryInstance;};exports.getQueryInstance=getQueryInstance;var getQueryFieldRequiredInComputation=function getQueryFieldRequiredInComputation(doc,_require,model){var _schema=model._schema,_relations=model._relations,_subQueries=model._subQueries;var subModels=getSubModels(_schema);var nestedFields=getNestedFields(_relations,subModels,_subQueries);var references=getReferenceFields(_schema,nestedFields);if(!_require||!references){return null;}var requiredReferenceFields=null;for(var k in _require){if(references[k]){var dottedFields=_require[k];if(isJSONObject(dottedFields)){var keys=Object.keys(dottedFields);if(keys.length>0){if(keys.length>1||keys.indexOf("_id")<0){requiredReferenceFields=requiredReferenceFields||{};if(!dottedFields._id){throw new Error("_id must be asked in dotted fields for reference ["+k+"]");}requiredReferenceFields[k]=dottedFields;}}}}}return requiredReferenceFields;};var runComputationEffect=function runComputationEffect(_ref3){var doc=_ref3.doc,requiredReferenceFields=_ref3.requiredReferenceFields,model=_ref3.model,_when=_ref3._when,_service=_ref3._service,_query=_ref3._query,_effect=_ref3._effect,_async=_ref3._async,old=_ref3.old,user=_ref3.user,op=_ref3.op,find=_ref3.find,invoke=_ref3.invoke,queryResult=_ref3.queryResult,invokeResult=_ref3.invokeResult,args=_ref3.args;if(requiredReferenceFields){return _Pipeline2.default.of().param({}).pipelineData().add(function(){return find(model,getQueryInstance(model,{id:"__anonyms__",fields:requiredReferenceFields,only:true,_data:[doc]}),args);},function(param,queryResult){doc=queryResult&&queryResult.result;return runComputationEffect({doc:doc,requiredReferenceFields:null,model:model,_when:_when,_service:_service,_query:_query,_effect:_effect,_async:_async,old:old,user:user,op:op,find:find,invoke:invoke,args:args});});}else{if(_when){var whenValue=_when({data:doc,user:user,op:op,old:old});if(!whenValue){return"__ignore__";}}if(_query){var qModel=_query.model,query=_query.query;if(typeof query==="function"){query=query({data:doc,user:user});}if(query){return _Pipeline2.default.of().param({}).pipelineData().add(function(){return find(qModel,getQueryInstance(qModel,query),args);},function(param,queryResult){queryResult=queryResult&&queryResult.result;return runComputationEffect({doc:doc,queryResult:queryResult,requiredReferenceFields:requiredReferenceFields,model:model,_when:_when,_service:_service,_async:_async,_query:null,_effect:_effect,old:old,user:user,op:op,find:find,invoke:invoke,args:args});});}else{return runComputationEffect({doc:doc,requiredReferenceFields:requiredReferenceFields,model:model,_when:_when,_service:_service,_query:null,queryResult:null,_effect:_effect,_async:_async,old:old,user:user,op:op,find:find,invoke:invoke,args:args});}}else if(_service){if(typeof _service==="function"){_service=_service({data:doc,user:user,queryResult:queryResult,op:op,old:old});}if(_service&&_service.service){return _Pipeline2.default.of().param({}).pipelineData().add(function(){return invoke(_service.service,_service.param,args);},function(param,invokeResult){invokeResult=invokeResult&&invokeResult.result;return runComputationEffect({doc:doc,queryResult:queryResult,invokeResult:invokeResult,requiredReferenceFields:requiredReferenceFields,model:model,_when:_when,_async:_async,_service:null,_effect:_effect,old:old,user:user,op:op,find:find,invoke:invoke,args:args});});}else{return runComputationEffect({doc:doc,requiredReferenceFields:requiredReferenceFields,model:model,_when:_when,_service:null,invokeResult:null,queryResult:queryResult,_effect:_effect,_async:_async,old:old,user:user,op:op,find:find,invoke:invoke,args:args});}}else if(_effect){if(_async){return Promise.resolve(_effect({data:doc,user:user,queryResult:queryResult,invokeResult:invokeResult,op:op,old:old}));}else{return _effect({data:doc,user:user,queryResult:queryResult,invokeResult:invokeResult,op:op,old:old});}}else{return invokeResult||queryResult;}}};var runAffectedComputations=function runAffectedComputations(data,user,computations,arrayFields,find,additionalParams,model,invoke,args){var computationKeys=Object.keys(computations);var pipeline=_Pipeline2.default.of("Run Affected Computations >>> "+JSON.stringify(computationKeys)+" ").param({});computationKeys.forEach(function(k){var _computations$k=computations[k],computation=_computations$k.computation,ids=_computations$k.ids,child=_computations$k.child,field=_computations$k.field,subModelObject=_computations$k.subModelObject;var _effect=computation._effect,_query=computation._query,_asObject=computation._asObject,_readOnly=computation._readOnly,_onChange=computation._onChange,_old=computation._old,_require=computation._require,_when=computation._when,_service=computation._service,_async=computation._async;if(child&&!subModelObject){var arrayData=data[child];ids.forEach(function(_id){var doc=getNestedDocToRun(data,getRecordWithId(arrayData,_id),computation);var requiredReferenceFields=null;pipeline.add(function(){return runComputationEffect({doc:doc,requiredReferenceFields:requiredReferenceFields,model:model,old:_old&&additionalParams&&additionalParams.old,_when:_when,_service:_service,_query:_query,_effect:_effect,_async:_async,user:user,find:find,invoke:invoke,args:args});},function(accum,output){if(output==="__ignore__"){return accum;}var objectToPush=_asObject?output?_extends({},output):{}:_defineProperty({},field,output);accum[child]=accum[child]||{ops:[],_array:true};accum[child].ops.push({_id:_id,doc:objectToPush});return accum;});});}else if(child&&subModelObject){var doc=getDocumentToRunComputation(data[child],computation);var requiredReferenceFields=null;pipeline.add(function(){return runComputationEffect({doc:doc,requiredReferenceFields:requiredReferenceFields,model:model,_when:_when,_service:_service,_query:_query,_effect:_effect,_async:_async,user:user,find:find,invoke:invoke,args:args});},function(accum,output){if(output==="__ignore__"){return accum;}var objectToPush=_asObject?output?_extends({},output):{}:_defineProperty({},field,output);accum[child]=accum[child]||{subModelObject:true,changes:objectToPush};return accum;});}else{var _doc=getDocumentToRunComputation(data,computation,arrayFields);var _requiredReferenceFields=getQueryFieldRequiredInComputation(_doc,_require,model);var requiredOldData=void 0;if(additionalParams){var old=additionalParams.old,op=additionalParams.op;if(_old){requiredOldData=old&&getDocumentToRunComputation(old,{_onChange:_onChange,_require:_require});}}pipeline.add(function(){return runComputationEffect({doc:_doc,requiredReferenceFields:_requiredReferenceFields,model:model,_when:_when,_service:_service,_async:_async,_query:_query,_effect:_effect,old:requiredOldData,user:user,op:op,find:find,invoke:invoke,args:args});},function(accum,output){if(output==="__ignore__"){return accum;}if(_readOnly){if(_asObject){throw new Error("readOnly is not support for asObject");}output={_readOnly:true,data:output};}var objectToPush=_asObject?output?_extends({},output):{}:_defineProperty({},field,output);_extends(accum,objectToPush);return accum;});}});return pipeline;};var computeRecursively=exports.computeRecursively=function computeRecursively(_ref7,find,invoke){var model=_ref7.model,data=_ref7.data,dataFields=_ref7.dataFields,changeFields=_ref7.changeFields,allChangeFields=_ref7.allChangeFields,computations=_ref7.computations,arrayFields=_ref7.arrayFields,childComputations=_ref7.childComputations,allAffectedComputations=_ref7.allAffectedComputations,ignoreComputations=_ref7.ignoreComputations,user=_ref7.user,old=_ref7.old,args=_ref7.args;allChangeFields=allChangeFields||{};dataFields=dataFields||{};var pipeline=_Pipeline2.default.of("Recursive compute").param({data:data,dataFields:dataFields,changeFields:allChangeFields,allAffectedComputations:allAffectedComputations});if(!getNullOrObject(computations)&&!getNullOrObject(childComputations)){return pipeline;}var affectedComputations=getAffectedComputations(data,changeFields,computations,childComputations,ignoreComputations,arrayFields);var hasAffectedComputations=affectedComputations&&Object.keys(affectedComputations).length;if(!hasAffectedComputations){return pipeline;}else{allAffectedComputations=allAffectedComputations||{};for(var k in affectedComputations){allAffectedComputations[k]=1;}}pipeline.add(function(){return runAffectedComputations(data,user,affectedComputations,arrayFields,find,{old:old},model,invoke,args);},function(accum,computationChanges){var hasComputationChanges=computationChanges&&Object.keys(computationChanges).length;if(!hasComputationChanges){return{data:data,changeFields:allChangeFields,allAffectedComputations:allAffectedComputations,dataFields:dataFields};}var newChangeFields={};for(var k in computationChanges){var val=computationChanges[k];if(isJSONObject(val)&&val._array){(function(){var arrayValue=data[k];allChangeFields[k]=allChangeFields[k]||{changes:[]};var arrayChanges=allChangeFields[k];var valOp=val.ops;valOp.forEach(function(v){var _id=v._id,doc=v.doc;var nestedArrayDoc=getRecordWithId(arrayValue,_id);var nestedFieldsChanged={};var matchedArrayChange=getRecordWithId(arrayChanges.changes,_id);if(!matchedArrayChange){matchedArrayChange={fields:{},_id:_id,op:"update"};arrayChanges.changes.push(matchedArrayChange);}var arrayPrevFields=matchedArrayChange.fields;for(var j in doc){var innerV=doc[j];nestedArrayDoc[j]=innerV;nestedFieldsChanged[j]=1;arrayPrevFields[j]=1;}newChangeFields[k]=newChangeFields[k]||{};newChangeFields[k].changes=newChangeFields[k].changes||[];newChangeFields[k].changes.push({_id:_id,fields:nestedFieldsChanged,op:matchedArrayChange.op});});})();}else if(isJSONObject(val)&&val._readOnly){data[k]=val.data;dataFields[k]=1;}else{if(arrayFields&&arrayFields[k]){if(Array.isArray(val)){newChangeFields[k]={override:true};val.forEach(function(v,_index){if(v._id){throw new Error("In array override case, _id can not be available >>> "+JSON.stringify(v));}v._id="new_"+(0,_v2.default)();var nestedFieldsChanged={};for(var obj in v){nestedFieldsChanged[obj]=1;}newChangeFields[k].changes=newChangeFields[k].changes||[];newChangeFields[k].changes.push({_id:v._id,fields:nestedFieldsChanged,op:"insert"});});var oldData=data[k];if(oldData){oldData.forEach(function(old){var _id=old._id;if(typeof _id=="string"&&_id.indexOf("new_")>=0){}else{newChangeFields[k]=newChangeFields[k]||{};newChangeFields[k].remove=newChangeFields[k].remove||[];newChangeFields[k].remove.push({_id:_id});}});}data[k]=val;allChangeFields[k]=newChangeFields[k];}}else if(val&&val.subModelObject){var changes=val.changes;var existingData=data[k]||{};for(var changeField in changes){var changeValue=changes[changeField];existingData[changeField]=changeValue;allChangeFields[k]=allChangeFields[k]||{changes:{},subModelObject:true};allChangeFields[k].changes[changeField]=1;newChangeFields[k]=newChangeFields[k]||{changes:{},subModelObject:true};newChangeFields[k].changes[changeField]=1;}data[k]=existingData;}else{data[k]=val;allChangeFields[k]=1;newChangeFields[k]=1;}}}return computeRecursively({model:model,data:data,dataFields:dataFields,changeFields:newChangeFields,allChangeFields:allChangeFields,computations:computations,arrayFields:arrayFields,childComputations:childComputations,allAffectedComputations:allAffectedComputations,ignoreComputations:ignoreComputations,user:user,old:old,args:args},find,invoke);});return pipeline;};var computeInternally=exports.computeInternally=function computeInternally(computations,arrayFields,childComputations,find,ignoreComputations,model,invoke){return _Pipeline2.default.of("Compute").add(function(_ref8){var data=_ref8.data,changeFields=_ref8.changeFields,user=_ref8.user,args=_ref8.args,old=_ref8.old;return computeRecursively({model:model,data:data,changeFields:changeFields,allChangeFields:changeFields,computations:computations,arrayFields:arrayFields,childComputations:childComputations,ignoreComputations:ignoreComputations,user:user,old:old,args:args},find,invoke);});};var compute=exports.compute=function compute(find,model,invoke){return _Pipeline2.default.of("Compute").add(function(_ref9){var data=_ref9.data,changeFields=_ref9.changeFields,computations=_ref9.computations,arrayFields=_ref9.arrayFields,childComputations=_ref9.childComputations,old=_ref9.old,args=_ref9.args;return computeRecursively({model:model,data:data,changeFields:changeFields,allChangeFields:changeFields,computations:computations,arrayFields:arrayFields,childComputations:childComputations,old:old,args:args},find,invoke);});};var getArrayFieldsChangesIfOverride=exports.getArrayFieldsChangesIfOverride=function getArrayFieldsChangesIfOverride(arrayChanges,oldData){if(!arrayChanges){return null;}var newChanges={};for(var k in arrayChanges){var arrayUpdates=arrayChanges[k];if(Array.isArray(arrayUpdates)){var oldValue=oldData&&oldData[k];arrayUpdates=getArrayChanges(arrayUpdates,oldValue);}else if(arrayUpdates===null){var _oldValue2=oldData&&oldData[k];arrayUpdates=getArrayChanges(arrayUpdates,_oldValue2);}newChanges[k]=arrayUpdates;}return newChanges;};var getNullOrObject=exports.getNullOrObject=function getNullOrObject(value){if(isJSONObject(value)&&Object.keys(value).length){return value;}else{return null;}};var separateNestedChanges=exports.separateNestedChanges=function separateNestedChanges(changes,nestedFields){var selfChanges={};var nestedChanges={};if(!nestedFields||!Object.keys(nestedFields)){selfChanges=changes;}else{for(var k in changes){if(nestedFields[k]){nestedChanges[k]=changes[k];}else{selfChanges[k]=changes[k];}}}var toReturn={selfChanges:getNullOrObject(selfChanges),nestedChanges:getNullOrObject(nestedChanges)};return toReturn;};var getChangesFromMergedData=exports.getChangesFromMergedData=function getChangesFromMergedData(mergedData,changeFields,fieldIncs,nestedFields,relations,subModelObjects){var selfChanges={};var subModelChanges={};var relationChanges={};for(var field in changeFields){if(nestedFields&&nestedFields[field]){var nestedChanges=getNestedChanges(field,mergedData[field],changeFields[field]);if(nestedChanges){if(relations&&relations[field]){relationChanges[field]=nestedChanges;}else{subModelChanges[field]=nestedChanges;}}}else if(subModelObjects&&subModelObjects[field]){var changeFieldValue=changeFields[field];if(changeFieldValue.override){selfChanges[field]=mergedData[field];}else if(changeFieldValue.changes){var _subModelChanges=changeFieldValue.changes;for(var objectKey in _subModelChanges){var key=field+"."+objectKey;selfChanges[key]=resolveValue(mergedData,key);}}}else if(fieldIncs&&fieldIncs.hasOwnProperty(field)){var oldValue=fieldIncs[field].old;selfChanges[field]={$inc:mergedData[field]-(oldValue||0)};}else{selfChanges[field]=mergedData[field];}}return{selfChanges:getNullOrObject(selfChanges),subModelChanges:getNullOrObject(subModelChanges),relationChanges:getNullOrObject(relationChanges)};};var getMergedFields=exports.getMergedFields=function getMergedFields(fields,addFields){if(!fields&&!addFields){return fields;}return _extends({},fields,addFields);};var getMergedFilter=exports.getMergedFilter=function getMergedFilter(filter,addFilter){if(!filter&&!addFilter){return filter;}filter=_extends({},filter);if(addFilter){var andFilter=filter.$and;filter.$and=andFilter?[].concat(_toConsumableArray(andFilter)):[];filter.$and.push(addFilter);}return filter;};var getRequiredParamValue=exports.getRequiredParamValue=function getRequiredParamValue(paramValue,param,globalParamValue){var rParam=_extends({},globalParamValue);return paramValue&&param?Object.keys(param).reduce(function(accum,current){var _paramValue=paramValue[current];accum[current]=_paramValue===undefined?rParam[current]||null:_paramValue;return accum;},rParam):rParam;};var getNestedChanges=function getNestedChanges(nestedField,data,changeFields){var relationChanges={};var changes=changeFields.changes,remove=changeFields.remove;if(remove){relationChanges.remove=remove.map(function(v){return{_id:v._id};});}changes&&changes.forEach(function(change){var matchedValue=getRecordWithId(data,change._id);if(!matchedValue){throw new Error("Value not found in data for id ["+change._id+"]");}var innerChanges={};for(var j in change.fields){innerChanges[j]=matchedValue[j];}if(change.op==="insert"){relationChanges.insert=relationChanges.insert||[];relationChanges.insert.push(innerChanges);}else if(change.op==="update"){relationChanges.update=relationChanges.update||[];if(innerChanges._id){throw new Error("_id can not be part of changes changes found >>"+JSON.stringify(innerChanges)+" >>> nested field>>>>"+nestedField);}relationChanges.update.push({_id:matchedValue._id,changes:innerChanges});}else{throw new Error("Op not supported in merged relation data >> found >> "+JSON.stringify(change.op)+" >>> change found >>>>>"+JSON.stringify(change)+" >>> array >>>"+nestedField);}});if(!Object.keys(relationChanges).length){relationChanges=null;}return relationChanges;};var getNestedFields=exports.getNestedFields=function getNestedFields(relations,subModels,subQueries){return getNullOrObject(_extends({},relations,subModels,subQueries));};var getFieldType=exports.getFieldType=function getFieldType(schema,field,skipError){var fieldType=schema&&schema[field];if(Array.isArray(fieldType)){fieldType=fieldType[0];}if(typeof fieldType==="function"){fieldType=fieldType();}if(fieldType===undefined&&!skipError){throw new Error("Schema not found for field ["+field+"] >>>>>> Available fields are >>>>> "+JSON.stringify(Object.keys(schema||{})));}return fieldType;};var isNull=exports.isNull=function isNull(value){return value===undefined||value===null;};var isNumber=exports.isNumber=function isNumber(value){return isNull(value)||typeof value==="number"||isJSONObject(value)&&isNumber(value.$inc);};var isDate=exports.isDate=function isDate(value){return isNull(value)||typeof value==="object"&&value instanceof Date;};var isBoolean=exports.isBoolean=function isBoolean(value){return isNull(value)||typeof value==="boolean";};var getSchema=exports.getSchema=function getSchema(model){return model._schema;};var getRelations=exports.getRelations=function getRelations(model){return model._relations;};var getSubQueries=exports.getSubQueries=function getSubQueries(model){return model._subQueries;};var getSubModels=exports.getSubModels=function getSubModels(schema){var subModels={};for(var field in schema){var fieldValue=schema[field];var _fieldType=getFieldType(schema,field);if(typeof _fieldType==="object"&&Array.isArray(fieldValue)&&_fieldType._isSubModel){subModels[field]=_fieldType;}}return getNullOrObject(subModels);};var getSubModelObjects=exports.getSubModelObjects=function getSubModelObjects(schema){var subModels={};for(var field in schema){var fieldValue=schema[field];var _fieldType2=getFieldType(schema,field);if(typeof _fieldType2==="object"&&!Array.isArray(fieldValue)&&_fieldType2._isSubModel){subModels[field]=_fieldType2;}}return getNullOrObject(subModels);};var getReferenceFields=exports.getReferenceFields=function getReferenceFields(schema,nestedFields){var referenceFields={};for(var field in schema){if(nestedFields&&nestedFields[field]){continue;}var _fieldType3=getFieldType(schema,field);if(typeof _fieldType3==="object"&&_fieldType3._isModel&&!_fieldType3._isSubModel){referenceFields[field]=1;}}return getNullOrObject(referenceFields);};var isReferenceField=exports.isReferenceField=function isReferenceField(refModel,field){if(typeof field!=="string"){return;}var refSchema=getSchema(refModel);var referenceFields=getReferenceFields(refSchema);if(referenceFields&&referenceFields[field]){return true;}};var getIdFilter=exports.getIdFilter=function getIdFilter(result){result=getFilterValue(result);if(!result){return;}else{return{_id:result};}};var getFilterValue=exports.getFilterValue=function getFilterValue(result){if(!result||!Array.isArray(result)){return result;}if(result.length===1){return result[0];}else{return{$in:result};}};var getComputations=exports.getComputations=function getComputations(computations,type){var requiredComputations={};for(var k in computations){var _type=computations[k]._type;if(_type===type||!_type){requiredComputations[k]=computations[k];}}return requiredComputations;};var getNestedComputations=exports.getNestedComputations=function getNestedComputations(nestedComputations,type){var _nestedComputations=null;for(var k in nestedComputations){var computations=getComputations(nestedComputations[k],type);if(computations){_nestedComputations=_nestedComputations||{};_nestedComputations[k]=computations;}}return _nestedComputations;};var getMandatoryValidations=function getMandatoryValidations(fieldInfo,mandatory,nestedField){var mandatoryValidations={};var _loop3=function _loop3(key){var label=fieldInfo&&fieldInfo[key]&&fieldInfo[key]["label"]?fieldInfo[key]["label"]:key;var onChange=["_id",key];mandatoryValidations["_mandatory_"+key]=_Validation2.default.of(function(_ref10){var data=_ref10.data;if(!data[key]){if(nestedField){return label+" of "+nestedField+" is mandatory";}return label+" is mandatory";}}).onChange(onChange).field(key);};for(var key in mandatory){_loop3(key);}return mandatoryValidations;};var getValidations=exports.getValidations=function getValidations(model,type,options){var fieldInfo=model._fieldInfo;var validations=options&&options._validations?options._validations:model._validations;var mandatory=options&&options._mandatory?options._mandatory:model._mandatory;if(mandatory){var mandatoryValidations=getMandatoryValidations(fieldInfo,mandatory);validations=_extends({},validations,mandatoryValidations);}else{validations=_extends({},validations);}return getComputations(validations,type);};var getNestedValidations=exports.getNestedValidations=function getNestedValidations(model,type){var _nestedValidations=model._nestedValidations?_extends({},model._nestedValidations):{};var nestedMandatory=model._nestedMandatory;if(nestedMandatory){for(var n in nestedMandatory){var _fieldType4=getFieldType(model._schema,n);if(_fieldType4&&_fieldType4._isModel){var nested=nestedMandatory[n];var nestedValidations=getMandatoryValidations(_fieldType4._fieldInfo,nested,n);_nestedValidations[n]=_nestedValidations[n]||{};for(var k in nestedValidations){_nestedValidations[n][k]=nestedValidations[k];}}}}return getNestedComputations(_nestedValidations,type);};var populateDottedFields=exports.populateDottedFields=function populateDottedFields(fields,pField){if(!fields){return;}var queryFields={};for(var key in fields){var value=fields[key];var mainKey=pField?pField+"."+key:key;if(isJSONObject(value)){var dottedFields=populateDottedFields(value,mainKey);_extends(queryFields,dottedFields);}else{queryFields[mainKey]=value;}}return queryFields;};var getOnChangeAsObject=function getOnChangeAsObject(value){if(isJSONObject(value)){var newValue={};for(var k in value){newValue[k]=getOnChangeAsObject(value[k]);}return newValue;}else{return 1;}};var resolveOnChange=exports.resolveOnChange=function resolveOnChange(args){var _onChange={};var _default={};args.forEach(function(arg){if(isJSONObject(arg)){for(var k in arg){_onChange[k]=getOnChangeAsObject(arg[k]);_default[k]=arg[k];}}else if(typeof arg==="string"){_onChange[arg]=1;}else if(Array.isArray(arg)){for(var _iterator=arg,_isArray=Array.isArray(_iterator),_i=0,_iterator=_isArray?_iterator:_iterator[typeof Symbol==="function"?Symbol.iterator:"@@iterator"]();;){var _ref11;if(_isArray){if(_i>=_iterator.length)break;_ref11=_iterator[_i++];}else{_i=_iterator.next();if(_i.done)break;_ref11=_i.value;}var k=_ref11;_onChange[k]=1;}}else{throw new Error("On Change args can either be string or object but found >> "+JSON.stringify(arg));}});return{_onChange:_onChange,_default:_default};};var validateDataPipeline=exports.validateDataPipeline=function validateDataPipeline(validations,param,nestedFields,nestedValidations,find,model,invoke){var data=param.data,user=param.user,changeFields=param.changeFields,op=param.op,old=param.old;if(!validations||!data){return;}var additionalParams={op:op,old:old};var pipeline=_Pipeline2.default.of("Db Connect - validation pipeline").param({});var affectedValidations=getAffectedComputations(data,changeFields,validations,nestedValidations,null,nestedFields,op);pipeline.add(function(){return runAffectedComputations(data,user,affectedValidations,nestedFields,find,additionalParams,model,invoke);},function(accum,validationChanges){var validationErrors={};for(var k in validationChanges){var value=validationChanges[k];if(isJSONObject(value)&&value._array){(function(){var ops=value.ops;var nestedError={};ops.forEach(function(op){var doc=op.doc,_id=op._id;var matchedIndex=getMatchedIndex(data[k],_id);for(var nestedField in doc){var nestedFieldValue=doc[nestedField];if(typeof nestedFieldValue==="string"){if(nestedError[_id]){nestedError[_id].errorFields=_extends({},nestedError[_id].errorFields,doc);}else{nestedError[_id]={index:matchedIndex,errorFields:doc};}}}});if(nestedError&&Object.keys(nestedError).length>0){validationErrors[k]=nestedError;}})();}if(typeof value==="string"){validationErrors[k]=value;}}if(getNullOrObject(validationErrors)){return{validationErrors:validationErrors};}});return pipeline;};var matchedIndex=exports.matchedIndex=function matchedIndex(values,row,field){if(!values||!row){return;}for(var i=0;i<values.length;i++){var cExp;var exp;if(field&&isJSONObject(row)){cExp=values[i][field];exp=row[field];}else{cExp=values[i];exp=row;}if(deepEqual(exp,cExp)){return i;}}};var mergeQueryFields=exports.mergeQueryFields=function mergeQueryFields(fields,fieldsToMerge){var newFields=_extends({},fields);for(var k in fieldsToMerge){var mergeFieldValue=fieldsToMerge[k];var existFieldValue=newFields[k];if(existFieldValue===undefined||existFieldValue===1){newFields[k]=mergeFieldValue;}else if(isJSONObject(mergeFieldValue)&&isJSONObject(existFieldValue)){var newMergedFields=mergeQueryFields(existFieldValue,mergeFieldValue);newFields[k]=newMergedFields;}else{}}return newFields;};var populateRelationReferenceFilter=function populateRelationReferenceFilter(refModel,reference,selfValue){var filterValue=getFilterValue(selfValue);if(!filterValue){filterValue={$in:[]};}var relationFilter=void 0;if(isJSONObject(reference)){var refFilters=[];for(var refKey in reference){var refKeyValue=reference[refKey];var refFilter={};if(refKeyValue===1){refFilter[refKey]=isReferenceField(refModel,refKey)?{_id:filterValue}:filterValue;}else if(typeof refKeyValue==="string"){refFilter[refKey]=_defineProperty({},refKeyValue,{_id:filterValue});}else{throw new Error("Invalid reference field found in relation >>>>> "+JSON.stringify(reference));}refFilters.push(refFilter);}if(refFilters.length){relationFilter=refFilters.length===1?refFilters[0]:{$or:refFilters};}}else{relationFilter=_defineProperty({},reference,isReferenceField(refModel,reference)?{_id:filterValue}:filterValue);}return relationFilter;};var isWhenRequired=exports.isWhenRequired=function isWhenRequired(params,when){return when!==undefined?when(params):true;};var getJoinFilterOneByOne=function getJoinFilterOneByOne(params,refModel,relationInfo){var data=params.data,restParams=_objectWithoutProperties(params,["data"]);var reference=relationInfo.reference,self=relationInfo.self,filter=relationInfo.filter,when=relationInfo.when;if(!isWhenRequired(params,when)){return;}var referenceFilter=void 0;if(reference){var selfValue=resolveValue(data,self);referenceFilter=populateRelationReferenceFilter(refModel,reference,selfValue);}if(!filter){return referenceFilter;}filter=filter(data,restParams);return _extends({},referenceFilter,filter);};exports.getJoinFilterOneByOne=getJoinFilterOneByOne;var getJoinFilter=function getJoinFilter(params,refModel,relationInfo){var data=params.data,restParams=_objectWithoutProperties(params,["data"]);var reference=relationInfo.reference,self=relationInfo.self,when=relationInfo.when;var ids=[];data&&data.forEach(function(row){if(isWhenRequired(_extends({},restParams,{data:row}),when)){var selfValue=resolveValue(row,self);if(selfValue!==undefined){if(Array.isArray(selfValue)){selfValue.forEach(function(selfId){if(ids.indexOf(selfId)===-1){ids.push(selfId);}});}else if(ids.indexOf(selfValue)===-1){ids.push(selfValue);}}}});if(ids.length===0){return;}var filterValue=getFilterValue(ids);return _defineProperty({},reference,isReferenceField(refModel,reference)?{_id:filterValue}:filterValue);};exports.getJoinFilter=getJoinFilter;var getNestedRelationValue=function getNestedRelationValue(id,relation,relationValue){if(Array.isArray(id)&&id.length===3&&id[1]===relation){return id[2];}else{throw new Error("Relation value must be an array with three hashes >> "+JSON.stringify({model:relationValue.model._id,_id:relationValue._id,relation:relationValue.relation}));}};var getRelationFilter=exports.getRelationFilter=function getRelationFilter(relationValue,model){if(!relationValue){return;}var relationFilter=getRelationFilterPipeline({relationValue:_extends({},relationValue,{model:model})});if(relationFilter&&typeof relationFilter==="object"&&!relationFilter._pipeline&&relationFilter.relationFilter){return relationFilter.relationFilter;}};var getRelationFilterPipeline=exports.getRelationFilterPipeline=function getRelationFilterPipeline(params,find){var relationValue=params.relationValue,_params$requiredParam=params.requiredParamValue,requiredParamValue=_params$requiredParam===undefined?{}:_params$requiredParam,user=params.user,args=params.args;var model=relationValue.model,_id=relationValue._id,relation=relationValue.relation;if(typeof _id==="string"&&_id.indexOf("/")>0){_id=_id.split("/");}if(typeof relation==="string"&&relation.indexOf(".")>=0){throw new Error("Dot not supported in relation value >>> "+relation);}if(relation==="_id"){return{relationFilter:{_id:_id}};}var schema=getSchema(model);var relations=getRelations(model);var subQueries=getSubQueries(model);var subModels=getSubModels(schema);var nestedFields=getNestedFields(relations,subModels,subQueries);var references=getReferenceFields(schema,nestedFields);var pipeline=_Pipeline2.default.of("getRelationFilter");if(references&&references[relation]){var fieldSchema=schema[relation];var multiple=Array.isArray(fieldSchema);if(multiple&&Array.isArray(_id)){return{relationFilter:{_id:getNestedRelationValue(_id,relation,relationValue)}};}else if(find){var relationQuery=_Query2.default.of().fields(_defineProperty({},relation,1)).filter({_id:_id}).scalar(relation+"._id").only();pipeline.add(find(model,relationQuery,args),function(param){var _ref13=arguments.length>1&&arguments[1]!==undefined?arguments[1]:{},result=_ref13.result;if(!result){throw new Error("Reference value not found relation value is "+JSON.stringify(_extends({},relationValue,{model:model._id})));}return{relationFilter:getIdFilter(result)};});}}else{var outerRelation=relation;var innerRelation=null;if(isJSONObject(relation)){outerRelation=Object.keys(relation)[0];innerRelation=relation[outerRelation];}if(subModels&&subModels[outerRelation]){if(!innerRelation){throw new Error("In a subModel relation, inner relation must be defined but not found >>>  Relation Value is "+JSON.stringify(relationValue));}else if(find){var _relationQuery=_Query2.default.of().fields(_defineProperty({_id:1},outerRelation,_defineProperty({_id:1},innerRelation,1))).filter({_id:Array.isArray(_id)?_id[0]:_id}).scalar(""+outerRelation).only();pipeline.add(find(model,_relationQuery,args),function(param){var _ref14=arguments.length>1&&arguments[1]!==undefined?arguments[1]:{},result=_ref14.result;if(Array.isArray(_id)){result=getRecordWithId(result,_id[2]);}result=resolveValue(result,innerRelation+"._id");return{relationFilter:getIdFilter(result)};});}}else if(relations&&relations[outerRelation]){if(innerRelation){throw new Error("Inner relation not supported in child query");}if(Array.isArray(_id)){var relationId=_id[1];var subQueryRelation=subQueries&&subQueries[relationId];if(subQueryRelation&&subQueryRelation._relation){_id[1]=subQueryRelation._relation;}return{relationFilter:{_id:getNestedRelationValue(_id,outerRelation,relationValue)}};}var outerRelationInfo=relations[outerRelation];var _outerRelationInfo$se=outerRelationInfo.self,self=_outerRelationInfo$se===undefined?"_id":_outerRelationInfo$se;var refModel=getFieldType(schema,outerRelation);if(typeof self==="string"){var joinAdditionalParams={paramValue:requiredParamValue,user:user};if(outerRelationInfo&&outerRelationInfo["recursive"]){pipeline.add(function(){var relationQuery=_Query2.default.of().fields(_defineProperty({_id:1},outerRelation,1)).filter({_id:_id}).scalar(outerRelation+"._id");return find(model,relationQuery,args);},function(param){var _ref15=arguments.length>1&&arguments[1]!==undefined?arguments[1]:{},result=_ref15.result;return{relationFilter:{_id:{$in:result}}};});}else if(self==="_id"){return{relationFilter:getJoinFilterOneByOne(_extends({data:{_id:_id}},joinAdditionalParams),refModel,_extends({},outerRelationInfo,{self:self}))};}else if(find){var isSelfReference=isReferenceField(model,self);pipeline.add(function(){var relationQuery=_Query2.default.of().fields(_defineProperty({_id:1},self,isSelfReference?{_id:1}:1)).filter({_id:_id}).only();return find(model,relationQuery,args);},function(param){var _ref16=arguments.length>1&&arguments[1]!==undefined?arguments[1]:{},result=_ref16.result;if(!result){throw new Error("Reference value not found relation value is "+JSON.stringify(relationValue));}return{relationFilter:getJoinFilterOneByOne(_extends({data:result},joinAdditionalParams),refModel,_extends({},outerRelationInfo,{self:isSelfReference?self+"._id":self}))};});}}else{throw new Error("self can not be json defined in relation >>>>> self >>> "+JSON.stringify(self));}}else{throw new Error("Not supported relation value >> >> "+JSON.stringify(_extends({},relationValue,{model:model._id})));}}return pipeline;};var asyncIterator=exports.asyncIterator=function asyncIterator(array,task){return new Promise(function(resolve,reject){if(!array||array.length===0){resolve();return;}try{var resolvedPromises=0;var errors=[];var onResolve=function onResolve(){finalResolve();};var onReject=function onReject(err){var errDetail={};errDetail.message=err.message;errDetail.stack=err.stack;errors.push(errDetail);finalResolve();};var finalResolve=function finalResolve(){resolvedPromises=resolvedPromises+1;if(resolvedPromises===array.length){if(errors.length>0){reject(new Error(errors.length>1?JSON.stringify(errors):JSON.stringify(errors[0])));}else{resolve();}}};for(var i=0;i<array.length;i++){callTask(i,array[i],task).then(onResolve).catch(onReject);}}catch(err){reject();}});};function callTask(i,record,task){return new Promise(function(resolve,reject){setImmediate(function(){var retValue=task(i,record);if(isThenable(retValue)){retValue.then(function(val){resolve(val);}).catch(function(err){reject(err);});}else{resolve(retValue);}});});}var isThenable=exports.isThenable=function isThenable(value){return typeof value==="object"&&value!==null&&typeof value.then==="function";};var populateReferredFks=exports.populateReferredFks=function populateReferredFks(referredFks,models,_table,model,objectFieldRelationInfo){var schema=model._schema;var _loop4=function _loop4(){var subQueries=getSubQueries(model);var relations=getRelations(model);if(relations&&relations[field]||subQueries&&subQueries[field]){return"continue";}isList=Array.isArray(schema[field]);var fieldType=getFieldType(schema,field);if(typeof fieldType==="object"&&fieldType._isModel&&!fieldType._isSubModel){referredModel=models.find(function(m){return m._id===fieldType._id;});if(referredModel){var referredModelId=referredModel._id;referredFks[referredModelId]=referredFks[referredModelId]||{};referredFks[referredModelId][_table]=referredFks[referredModelId][_table]||{};var referredFksInMerge=referredFks[referredModelId][_table];if(objectFieldRelationInfo){isObjectList=objectFieldRelationInfo.isList;objectField=objectFieldRelationInfo.field;parentInfo=objectFieldRelationInfo.parentInfo;if(parentInfo){referredFksInMerge[parentInfo.field]=referredFksInMerge[parentInfo.field]||{isList:parentInfo.isList,fields:{}};referredFksInMerge=referredFksInMerge[parentInfo.field].fields;}referredFksInMerge[objectField]=referredFksInMerge[objectField]||{isList:isObjectList,fields:{}};referredFksInMerge=referredFksInMerge[objectField].fields;}referredFksInMerge[field]={isList:isList};}}else if(fieldType._isSubModel){var subModalFieldInfo={isList:isList,field:field};if(objectFieldRelationInfo){subModalFieldInfo.parentInfo=objectFieldRelationInfo;}populateReferredFks(referredFks,models,_table,fieldType,subModalFieldInfo);}};for(var field in schema){var isList;var referredModel;var isObjectList,objectField,parentInfo;var _ret6=_loop4();if(_ret6==="continue")continue;}};var isNativeSort=exports.isNativeSort=function isNativeSort(sort){if(!sort){return;}var isNative=function isNative(sort,pKey){for(var key in sort){var val=sort[key];if(pKey&&key!=="_id"){return true;}if(isJSONObject(val)){if(isNative(val,key)){return true;}}}return false;};return isNative(sort);};var getNativeSort=exports.getNativeSort=function getNativeSort(sort){if(!sort){return;}var fields={};var dottedSort=function dottedSort(sort,fields,pkey){for(var f in sort){var val=sort[f];var key=pkey?pkey+"."+f:f;if(val===1||val===-1){fields[key]=val;}else if(isJSONObject(val)){dottedSort(val,fields,key);}else{throw new Error("Not supported value ["+JSON.stringify(val)+"] with key ["+f+"] in sort.");}}};dottedSort(sort,fields);return fields;};var getMemorySort=exports.getMemorySort=function getMemorySort(sort){if(!sort){return;}var fields=[];var directions=[];var dottedMemorySort=function dottedMemorySort(sort,fields,directions,pkey){for(var f in sort){var val=sort[f];var key=pkey?pkey+"."+f:f;if(val===1){fields.push(key);directions.push("asc");}else if(val===-1){fields.push(key);directions.push("desc");}else if(isJSONObject(val)){dottedMemorySort(val,fields,directions,key);}else{throw new Error("Not supported value ["+JSON.stringify(val)+"] with key ["+f+"] in sort.");}}};dottedMemorySort(sort,fields,directions);return{fields:fields,directions:directions};};var putDottedValue=exports.putDottedValue=function putDottedValue(data,key,value){if(!data){throw new Error("data does not exists for putting dotted value");}var lastDottedIndex=key.lastIndexOf(".");if(lastDottedIndex>=0){var firstExpression=key.substring(0,lastDottedIndex);key=key.substring(lastDottedIndex+1);data=resolveDottedValue(data,firstExpression,true);}data[key]=value;};var resolveDottedValue=exports.resolveDottedValue=function resolveDottedValue(data,expression,confirm,confirmType){if(!data){return;}while(expression!==undefined){var fieldIndex=expression.indexOf(".");var exp=expression;if(fieldIndex>=0){exp=expression.substring(0,fieldIndex);expression=expression.substring(fieldIndex+1);}else{expression=undefined;}if((data[exp]===undefined||data[exp]===null)&&!confirm){return;}if(data[exp]!==undefined&&data[exp]!==null){data=data[exp];}else{if(expression){data[exp]={};}else{if(confirmType==="array"){data[exp]=[];}else{data[exp]={};}}data=data[exp];}}return data;};