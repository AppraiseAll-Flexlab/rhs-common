Object.defineProperty(exports,"__esModule",{value:true});var _createClass=function(){function defineProperties(target,props){for(var i=0;i<props.length;i++){var descriptor=props[i];descriptor.enumerable=descriptor.enumerable||false;descriptor.configurable=true;if("value"in descriptor)descriptor.writable=true;Object.defineProperty(target,descriptor.key,descriptor);}}return function(Constructor,protoProps,staticProps){if(protoProps)defineProperties(Constructor.prototype,protoProps);if(staticProps)defineProperties(Constructor,staticProps);return Constructor;};}();var _PureFunctions=require("./PureFunctions");function _classCallCheck(instance,Constructor){if(!(instance instanceof Constructor)){throw new TypeError("Cannot call a class as a function");}}var Logger=function(){function Logger(_ref){var _this=this;var token=_ref.token,user=_ref.user,loggerConfig=_ref.loggerConfig;_classCallCheck(this,Logger);this.modifyFilter=function(filter){if((0,_PureFunctions.isJSONObject)(filter)){for(var k in filter){var value=filter[k];if(value===undefined){filter[k]="__undefined";}else if((0,_PureFunctions.isJSONObject)(value)){_this.modifyFilter(value);}else if(k=="$in"&&value&&value.length>10){filter[k]=[value[0],value[1],value.length-10+" more"];}else if(Array.isArray(value)){value.forEach(function(v){_this.modifyFilter(v);});}}}};this.token=token;this.startTime=new Date();this.dbTime=0;this.logs=[];this.tables={};this.loggerConfig=loggerConfig;}_createClass(Logger,[{key:"startLog",value:function startLog(_ref2){var _this2=this;var model=_ref2.model,table=_ref2.table,op=_ref2.op,_ref2$log=_ref2.log,log=_ref2$log===undefined?{}:_ref2$log,native=_ref2.native;this.loggerConfig&&this.loggerConfig.onLog&&this.loggerConfig.onLog({model:model,table:table,op:op,log:log});var query=log.query,pipeline=log.pipeline;if(query){query=(0,_PureFunctions.deepClone)(query);}if(pipeline){pipeline=(0,_PureFunctions.deepClone)(pipeline);}if(query&&query.filter){this.modifyFilter(query.filter);}else if(pipeline){pipeline.forEach(function(p){if(p.$match){_this2.modifyFilter(p.$match);}});}var info={startTime:new Date(),model:model,table:table,op:op,log:{query:query,pipeline:pipeline}};if(this.parentLog){this.parentLog.logs=this.parentLog.logs||[];this.parentLog.logs.push(info);this.parents=this.parents||[];this.parents.push(this.parentLog);}else{this.logs.push(info);}this.parentLog=info;return function(){info.endTime=new Date();info.totalTime=info.endTime-info.startTime;if(native){_this2.tables[table]=_this2.tables[table]||{count:0,totalTime:0};_this2.tables[table].count=_this2.tables[table].count+1;_this2.tables[table].totalTime=_this2.tables[table].totalTime+info.totalTime;_this2.dbTime+=info.totalTime;}var parentLength=_this2.parents&&_this2.parents.length;if(parentLength>0){_this2.parentLog=_this2.parents[parentLength-1];_this2.parents.splice(parentLength-1,1);}else{_this2.parentLog=null;}};}},{key:"endLogging",value:function endLogging(){var endTime=new Date();var totalTime=endTime-this.startTime;return{startTime:this.startTime,endTime:endTime,totalTime:totalTime,logs:this.logs,tables:this.tables,dbTime:this.dbTime};}}]);return Logger;}();exports.default=Logger;